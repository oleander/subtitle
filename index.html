<!DOCTYPE HTML>
<html>
<head>
<script type="text/javascript">window.nRequire = require</script>

<script>

var opensubtitles = nRequire("subtitler");
var gUrl = "http://dl.opensubtitles.org/en/download/filead/src-api/vrf-19dc0c5e/sid-651bm29a5qjjt3bo21l7868lp2/1954774457.gz"

function allowDrop(ev) {
    ev.preventDefault();
}

function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
}


var token = null;
opensubtitles.api.login().then(function(t){
  token = t;
});


function drop(ev) {
    ev.preventDefault();
    var file = ev.dataTransfer.files[0]
    console.info(file.name);
    console.info(file.path);

    var search = require("path").parse(file.name).name;
    console.info("search for", search)
    opensubtitles.api.searchForTitle(token, "eng", search).then(function(results){
      console.info("search", results.length);
      if(!results[0]) {
        results[0] = {
          SubDownloadLink: gUrl,
          SubFileName: "hello.srt"
        }
      }
      if(results[0]){
        console.info("IN!")
        console.info( results[0])
        var url = results[0].SubDownloadLink

        request = nRequire("request");
        console.info("downloading", url);
        var g = request(url)
        var p = nRequire("path").dirname(file.path)
        console.info("save to", p + "/" + results[0].SubFileName);
        var u = require("url").parse(url);
        var zlib = require('zlib');
        var http = require('http');
        var fs = require('fs');
        var request = http.get({ 
            host: u.host,
            path: u.path,
            port: 80
        });
        request.on('response', function(response) {
          var output = fs.createWriteStream(p + "/" + results[0].SubFileName);
          response.pipe(zlib.createGunzip()).pipe(output);
        });

      }
    });

    // var data = ev.dataTransfer.getData("text");
    // ev.target.appendChild(document.getElementById(data));
}
</script>
</head>
<body>

<style type="text/css">
  #div1 {
    height: 100px;
    width: 100px;
    border: 1px solid;
  }
</style>
<div id="div1" ondrop="drop(event)" ondragover="allowDrop(event)">
  
</div>

<img id="drag1" src="img_logo.gif" draggable="true"
ondragstart="drag(event)" width="336" height="69">

</body>
</html>