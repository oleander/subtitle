<!DOCTYPE HTML>
<html>
<head>

<link rel="stylesheet" type="text/css" href="css/application.css">
<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
<script type="text/javascript">
  window.$ = window.jQuery = require(__dirname + "/js/jquery-1.11.3.min.js");
</script>

<script type="text/javascript">
  var opensubtitles = require("subtitler");
  var zlib = require('zlib');
  var http = require('http');
  var fs = require('fs');
  var path = require("path")
  var url = require("url");
  var settle = require("promise-settle");

  var token = null;
  opensubtitles.api.login().then(function(t){
    token = t;
  });

  function allowDrop(event) {
    event.preventDefault();
  };

  var searchAndDownload = function(token, lang, query, file_path) {
    return new Promise(function(accept, reject){
      opensubtitles.api.searchForTitle(token, lang, query).then(function(results){
        if(!results[0]) { return reject(); }
        if(results[0]){
          var downloadUrl = results[0].SubDownloadLink
          var p = path.dirname(file_path)
          var u = url.parse(downloadUrl);
          var request = http.get({ 
              host: u.host,
              path: u.path,
              port: 80
          });
          request.on("response", function(response) {
            var fileData = path.parse(results[0].SubFileName)
            var output = fs.createWriteStream(p + "/" + fileData.name + "-" + lang + fileData.ext);
            response.pipe(zlib.createGunzip()).pipe(output);
          });
          accept();
        }
      }).fail(function(err) {
        reject()
      });
    })
  }

  function drop(ev) {
      loading();
      ev.preventDefault();
      var file = ev.dataTransfer.files[0]
      var query = path.parse(file.name).name;
      var proms = ["eng", "swe"].map(function(lang) {
        return searchAndDownload(token, lang, query, file.path);
      });

      settle(proms).then(function(results) {
        var anyOne = false;
        results.forEach(function (result) {
          if (result.isFulfilled()) { anyOne = true; }
        });

        anyOne ? ok() : no();
      }).catch(function(e) {
        no();
      });
  }

  var $loading, $ok, $no, clearOk, clearNo, $info;

  var clear = function() {
    clearInterval(clearOk);
    clearInterval(clearNo);
  };

  var loading = function() {
    clear();
    $info.hide();
    $loading.show();
    $ok.hide();
    $no.hide();
  };

  var ok = function() {
    clear();
    $info.hide();
    $loading.hide();
    $ok.show();
    $no.hide();
    clearOk = setTimeout(function() {
      $ok.hide();
      $info.show();
    }, 5000);
  };

  var no = function() {
    clear();
    $info.hide();
    $loading.hide();
    $ok.hide();
    $no.show();
    clearNo = setTimeout(function() {
      $no.hide();
      $info.show();
    }, 5000);
  };

  $(function() {
    $loading = $("#loading").hide();
    $ok = $("#ok").hide();
    $no = $("#no").hide();
    $info = $("#info");
  });
</script>

<style type="text/css">
  
  #upload {               
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);    
      -webkit-transform: translate(-50%, -50%);
      -moz-transform: translate(-50%, -50%);
      -ms-transform: translate(-50%, -50%);
  }

</style>
</head>
<body style="background-color: #313437">
  <div style="margin: 0 auto" id="upload" ondrop="drop(event)" ondragover="allowDrop(event)">
    <div id="drop">
      <div style="font-size: 25px; margin-bottom: 24px; margin-top: 24px;" id="info">Drop Here</div>
      <i id="ok" class="fa fa-check fa-5x"></i>
      <i id="no" class="fa fa-times fa-5x"></i>
      <i id="loading" class="spin fa fa-spinner fa-5x"></i>
    </div>
  </div>
</body>
</html>